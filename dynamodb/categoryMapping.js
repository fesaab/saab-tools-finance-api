"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const dynamodbUtils = require("./utils");
const constants_1 = require("../utils/constants");
class CategoryMappingRepository {
    constructor() {
        this.dynamoDbClient = dynamodbUtils.createDynamoDbClient(constants_1.constants.AWS_REGION);
    }
    async query(props) {
        var _a;
        try {
            const queryParameters = {
                TableName: `${process.env[constants_1.constants.ENV_VAR_DYNAMODB_TABLE_CATEGORY_MAPPING]}`,
                KeyConditionExpression: "#description = :description",
                ExpressionAttributeNames: { "#description": "description" },
                ExpressionAttributeValues: { ":description": { "S": props.description } }
            };
            // Query the table
            const data = await this.dynamoDbClient.query(queryParameters).promise();
            // Map and return the result
            let categoryMappingList = this.mapResultList(data.Items);
            let response = {
                categoryMappingList: categoryMappingList,
                count: data.Count || 0,
                lastEvaluatedKey: ((_a = data.LastEvaluatedKey) === null || _a === void 0 ? void 0 : _a.id.S) || ''
            };
            return new Promise(resolve => resolve(response));
        }
        catch (exception) {
            // exception: AWS.AWSError
            console.error(exception);
            throw exception;
        }
    }
    async putItem(categoryMapping) {
        try {
            const putItemParameters = {
                TableName: `${process.env[constants_1.constants.ENV_VAR_DYNAMODB_TABLE_CATEGORY_MAPPING]}`,
                Item: {
                    "description": { "S": categoryMapping.description },
                    "category": { "S": categoryMapping.category },
                    "regex": { "BOOL": categoryMapping.regex }
                }
            };
            // Persist the item
            const data = await this.dynamoDbClient.putItem(putItemParameters).promise();
            // Map and return the result
            let categoryMappingPersisted = this.mapResult(data.Attributes);
            return new Promise(resolve => resolve(categoryMappingPersisted));
        }
        catch (exception) {
            // exception: AWS.AWSError
            console.error(exception);
            throw exception;
        }
    }
    mapResultList(data) {
        let categoryMappingList = [];
        if (data && data.length > 0) {
            for (let i = 0; i < data.length; i++) {
                categoryMappingList.push(this.mapResult(data[i]));
            }
            // Sort the result by date
            categoryMappingList.sort((a, b) => a.date - b.date);
        }
        return categoryMappingList;
    }
    mapResult(item) {
        return {
            description: item === null || item === void 0 ? void 0 : item.description.S,
            category: item === null || item === void 0 ? void 0 : item.category.S,
            regex: item === null || item === void 0 ? void 0 : item.regex.BOOL
        };
    }
}
exports.CategoryMappingRepository = CategoryMappingRepository;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2F0ZWdvcnlNYXBwaW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2F0ZWdvcnlNYXBwaW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EseUNBQXlDO0FBQ3pDLGtEQUE4QztBQWtCOUMsTUFBYSx5QkFBeUI7SUFJbEM7UUFDSSxJQUFJLENBQUMsY0FBYyxHQUFHLGFBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxxQkFBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ25GLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQWdCOztRQUN4QixJQUFJO1lBQ0EsTUFBTSxlQUFlLEdBQWtDO2dCQUNuRCxTQUFTLEVBQUUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFTLENBQUMsdUNBQXVDLENBQUMsRUFBRTtnQkFDOUUsc0JBQXNCLEVBQUUsNkJBQTZCO2dCQUNyRCx3QkFBd0IsRUFBRSxFQUFFLGNBQWMsRUFBRSxhQUFhLEVBQUU7Z0JBQzNELHlCQUF5QixFQUFFLEVBQUUsY0FBYyxFQUFFLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFBRTthQUM1RSxDQUFDO1lBRUYsa0JBQWtCO1lBQ2xCLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7WUFFeEUsNEJBQTRCO1lBQzVCLElBQUksbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDekQsSUFBSSxRQUFRLEdBQTJDO2dCQUNuRCxtQkFBbUIsRUFBRSxtQkFBbUI7Z0JBQ3hDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUM7Z0JBQ3RCLGdCQUFnQixFQUFFLE9BQUEsSUFBSSxDQUFDLGdCQUFnQiwwQ0FBRSxFQUFFLENBQUMsQ0FBQyxLQUFJLEVBQUU7YUFDdEQsQ0FBQztZQUVGLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztTQUVwRDtRQUFDLE9BQU8sU0FBUyxFQUFFO1lBQ2hCLDBCQUEwQjtZQUMxQixPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3pCLE1BQU0sU0FBUyxDQUFDO1NBQ25CO0lBQ0wsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFPLENBQUMsZUFBZ0M7UUFDMUMsSUFBSTtZQUVBLE1BQU0saUJBQWlCLEdBQW9DO2dCQUN2RCxTQUFTLEVBQUUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFTLENBQUMsdUNBQXVDLENBQUMsRUFBRTtnQkFDOUUsSUFBSSxFQUFFO29CQUNGLGFBQWEsRUFBRSxFQUFFLEdBQUcsRUFBRyxlQUFlLENBQUMsV0FBVyxFQUFFO29CQUNwRCxVQUFVLEVBQUUsRUFBRSxHQUFHLEVBQUUsZUFBZSxDQUFDLFFBQVEsRUFBRTtvQkFDN0MsT0FBTyxFQUFFLEVBQUUsTUFBTSxFQUFFLGVBQWUsQ0FBQyxLQUFLLEVBQUU7aUJBQzdDO2FBQ0osQ0FBQztZQUVGLG1CQUFtQjtZQUNuQixNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7WUFFNUUsNEJBQTRCO1lBQzVCLElBQUksd0JBQXdCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDL0QsT0FBTyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDLENBQUM7U0FFcEU7UUFBQyxPQUFPLFNBQVMsRUFBRTtZQUNoQiwwQkFBMEI7WUFDMUIsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN6QixNQUFNLFNBQVMsQ0FBQztTQUNuQjtJQUNMLENBQUM7SUFFTyxhQUFhLENBQUMsSUFBNEI7UUFDOUMsSUFBSSxtQkFBbUIsR0FBMkIsRUFBRSxDQUFDO1FBRXJELElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3pCLEtBQUssSUFBSSxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsR0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUM5QixtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3JEO1lBRUQsMEJBQTBCO1lBQzFCLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQU0sRUFBRSxDQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2pFO1FBRUQsT0FBTyxtQkFBbUIsQ0FBQztJQUMvQixDQUFDO0lBRU8sU0FBUyxDQUFDLElBQWdDO1FBQzlDLE9BQU87WUFDSCxXQUFXLEVBQUUsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQ2hDLFFBQVEsRUFBRSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsUUFBUSxDQUFDLENBQUM7WUFDMUIsS0FBSyxFQUFFLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxLQUFLLENBQUMsSUFBSTtTQUMxQixDQUFDO0lBQ04sQ0FBQztDQUVKO0FBdEZELDhEQXNGQztBQUFBLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBBV1MgZnJvbSAnYXdzLXNkayc7XHJcbmltcG9ydCAqIGFzIGR5bmFtb2RiVXRpbHMgZnJvbSAnLi91dGlscyc7XHJcbmltcG9ydCB7IGNvbnN0YW50cyB9IGZyb20gJy4uL3V0aWxzL2NvbnN0YW50cydcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQ2F0ZWdvcnlNYXBwaW5nIHtcclxuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nLFxyXG4gICAgY2F0ZWdvcnk/OiBzdHJpbmcsXHJcbiAgICByZWdleD86IGJvb2xlYW5cclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBMaXN0UHJvcHMge1xyXG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmdcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDYXRlZ29yeU1hcHBpbmdSZXBvc2l0b3J5TGlzdFJlc3BvbnNlIHtcclxuICAgIGNhdGVnb3J5TWFwcGluZ0xpc3Q6IEFycmF5PENhdGVnb3J5TWFwcGluZz4sXHJcbiAgICBjb3VudDogbnVtYmVyLFxyXG4gICAgbGFzdEV2YWx1YXRlZEtleTogc3RyaW5nXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBDYXRlZ29yeU1hcHBpbmdSZXBvc2l0b3J5IHtcclxuXHJcbiAgICBwcml2YXRlIGR5bmFtb0RiQ2xpZW50OiBBV1MuRHluYW1vREI7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5keW5hbW9EYkNsaWVudCA9IGR5bmFtb2RiVXRpbHMuY3JlYXRlRHluYW1vRGJDbGllbnQoY29uc3RhbnRzLkFXU19SRUdJT04pO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHF1ZXJ5KHByb3BzOiBMaXN0UHJvcHMpOiBQcm9taXNlPENhdGVnb3J5TWFwcGluZ1JlcG9zaXRvcnlMaXN0UmVzcG9uc2U+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBxdWVyeVBhcmFtZXRlcnM6IEFXUy5EeW5hbW9EQi5UeXBlcy5RdWVyeUlucHV0ID0ge1xyXG4gICAgICAgICAgICAgICAgVGFibGVOYW1lOiBgJHtwcm9jZXNzLmVudltjb25zdGFudHMuRU5WX1ZBUl9EWU5BTU9EQl9UQUJMRV9DQVRFR09SWV9NQVBQSU5HXX1gLFxyXG4gICAgICAgICAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogXCIjZGVzY3JpcHRpb24gPSA6ZGVzY3JpcHRpb25cIixcclxuICAgICAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogeyBcIiNkZXNjcmlwdGlvblwiOiBcImRlc2NyaXB0aW9uXCIgfSxcclxuICAgICAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHsgXCI6ZGVzY3JpcHRpb25cIjogeyBcIlNcIjogcHJvcHMuZGVzY3JpcHRpb24gfSB9XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAvLyBRdWVyeSB0aGUgdGFibGVcclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuZHluYW1vRGJDbGllbnQucXVlcnkocXVlcnlQYXJhbWV0ZXJzKS5wcm9taXNlKCk7XHJcblxyXG4gICAgICAgICAgICAvLyBNYXAgYW5kIHJldHVybiB0aGUgcmVzdWx0XHJcbiAgICAgICAgICAgIGxldCBjYXRlZ29yeU1hcHBpbmdMaXN0ID0gdGhpcy5tYXBSZXN1bHRMaXN0KGRhdGEuSXRlbXMpO1xyXG4gICAgICAgICAgICBsZXQgcmVzcG9uc2U6IENhdGVnb3J5TWFwcGluZ1JlcG9zaXRvcnlMaXN0UmVzcG9uc2UgID0ge1xyXG4gICAgICAgICAgICAgICAgY2F0ZWdvcnlNYXBwaW5nTGlzdDogY2F0ZWdvcnlNYXBwaW5nTGlzdCxcclxuICAgICAgICAgICAgICAgIGNvdW50OiBkYXRhLkNvdW50IHx8IDAsXHJcbiAgICAgICAgICAgICAgICBsYXN0RXZhbHVhdGVkS2V5OiBkYXRhLkxhc3RFdmFsdWF0ZWRLZXk/LmlkLlMgfHwgJydcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHJlc29sdmUocmVzcG9uc2UpKTtcclxuXHJcbiAgICAgICAgfSBjYXRjaCAoZXhjZXB0aW9uKSB7XHJcbiAgICAgICAgICAgIC8vIGV4Y2VwdGlvbjogQVdTLkFXU0Vycm9yXHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXhjZXB0aW9uKTtcclxuICAgICAgICAgICAgdGhyb3cgZXhjZXB0aW9uO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBwdXRJdGVtKGNhdGVnb3J5TWFwcGluZzogQ2F0ZWdvcnlNYXBwaW5nKTogUHJvbWlzZTxDYXRlZ29yeU1hcHBpbmc+IHtcclxuICAgICAgICB0cnkge1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcHV0SXRlbVBhcmFtZXRlcnM6IEFXUy5EeW5hbW9EQi5UeXBlcy5QdXRJdGVtSW5wdXQgPSB7XHJcbiAgICAgICAgICAgICAgICBUYWJsZU5hbWU6IGAke3Byb2Nlc3MuZW52W2NvbnN0YW50cy5FTlZfVkFSX0RZTkFNT0RCX1RBQkxFX0NBVEVHT1JZX01BUFBJTkddfWAsXHJcbiAgICAgICAgICAgICAgICBJdGVtOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgXCJkZXNjcmlwdGlvblwiOiB7IFwiU1wiIDogY2F0ZWdvcnlNYXBwaW5nLmRlc2NyaXB0aW9uIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgXCJjYXRlZ29yeVwiOiB7IFwiU1wiOiBjYXRlZ29yeU1hcHBpbmcuY2F0ZWdvcnkgfSxcclxuICAgICAgICAgICAgICAgICAgICBcInJlZ2V4XCI6IHsgXCJCT09MXCI6IGNhdGVnb3J5TWFwcGluZy5yZWdleCB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAvLyBQZXJzaXN0IHRoZSBpdGVtXHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLmR5bmFtb0RiQ2xpZW50LnB1dEl0ZW0ocHV0SXRlbVBhcmFtZXRlcnMpLnByb21pc2UoKTtcclxuXHJcbiAgICAgICAgICAgIC8vIE1hcCBhbmQgcmV0dXJuIHRoZSByZXN1bHRcclxuICAgICAgICAgICAgbGV0IGNhdGVnb3J5TWFwcGluZ1BlcnNpc3RlZCA9IHRoaXMubWFwUmVzdWx0KGRhdGEuQXR0cmlidXRlcyk7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHJlc29sdmUoY2F0ZWdvcnlNYXBwaW5nUGVyc2lzdGVkKSk7XHJcblxyXG4gICAgICAgIH0gY2F0Y2ggKGV4Y2VwdGlvbikge1xyXG4gICAgICAgICAgICAvLyBleGNlcHRpb246IEFXUy5BV1NFcnJvclxyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGV4Y2VwdGlvbik7XHJcbiAgICAgICAgICAgIHRocm93IGV4Y2VwdGlvbjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBtYXBSZXN1bHRMaXN0KGRhdGE/OiBBV1MuRHluYW1vREIuSXRlbUxpc3QpOiBBcnJheTxDYXRlZ29yeU1hcHBpbmc+IHtcclxuICAgICAgICBsZXQgY2F0ZWdvcnlNYXBwaW5nTGlzdDogQXJyYXk8Q2F0ZWdvcnlNYXBwaW5nPiA9IFtdO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmIChkYXRhICYmIGRhdGEubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8ZGF0YS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgY2F0ZWdvcnlNYXBwaW5nTGlzdC5wdXNoKHRoaXMubWFwUmVzdWx0KGRhdGFbaV0pKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gU29ydCB0aGUgcmVzdWx0IGJ5IGRhdGVcclxuICAgICAgICAgICAgY2F0ZWdvcnlNYXBwaW5nTGlzdC5zb3J0KChhOiBhbnksIGI6IGFueSkgPT4gYS5kYXRlIC0gYi5kYXRlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBjYXRlZ29yeU1hcHBpbmdMaXN0O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbWFwUmVzdWx0KGl0ZW0/OiBBV1MuRHluYW1vREIuQXR0cmlidXRlTWFwKSA6IENhdGVnb3J5TWFwcGluZyB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGl0ZW0/LmRlc2NyaXB0aW9uLlMsXHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiBpdGVtPy5jYXRlZ29yeS5TLFxyXG4gICAgICAgICAgICByZWdleDogaXRlbT8ucmVnZXguQk9PTFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG59OyJdfQ==