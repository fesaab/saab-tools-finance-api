"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const dynamodbUtils = require("./utils");
const constants_1 = require("../utils/constants");
class TransactionRepository {
    constructor() {
        this.dynamoDbClient = dynamodbUtils.createDynamoDbClient(constants_1.constants.AWS_REGION);
    }
    async list(props) {
        var _a;
        try {
            // If it is a search without parameter it is paginates
            const scanParameters = {
                TableName: `${process.env[constants_1.constants.ENV_VAR_DYNAMODB_TABLE_TRANSACTIONS]}`,
                Limit: 10
            };
            // Update the query with the filter properties
            if (props.startDate || props.endDate) {
                let filterExpression = "";
                let expressionAttributeValues = {};
                let expressionAttributeNames = {};
                if (props.startDate) {
                    filterExpression = "#startDate >= :startDate";
                    expressionAttributeNames["#startDate"] = "date";
                    expressionAttributeValues[":startDate"] = { "S": props.startDate };
                }
                if (props.endDate) {
                    if (filterExpression != "") {
                        filterExpression += " and ";
                    }
                    filterExpression += "#endDate <= :endDate";
                    expressionAttributeNames["#endDate"] = "date";
                    expressionAttributeValues[":endDate"] = { "S": props.endDate };
                }
                scanParameters.FilterExpression = filterExpression;
                scanParameters.ExpressionAttributeNames = expressionAttributeNames;
                scanParameters.ExpressionAttributeValues = expressionAttributeValues;
                delete scanParameters.Limit; // Return everything!
            }
            // Scan the table
            const data = await this.dynamoDbClient.scan(scanParameters).promise();
            // Map and return the result
            let transactionList = this.mapTransactionResult(data.Items);
            let response = {
                transactionList: transactionList,
                count: data.Count || 0,
                lastEvaluatedKey: ((_a = data.LastEvaluatedKey) === null || _a === void 0 ? void 0 : _a.id.S) || ''
            };
            return new Promise(resolve => resolve(response));
        }
        catch (exception) {
            // exception: AWS.AWSError
            return new Promise(rejects => rejects(exception));
        }
    }
    async query(props) {
        var _a;
        try {
            const queryParameters = {
                TableName: `${process.env[constants_1.constants.ENV_VAR_DYNAMODB_TABLE_TRANSACTIONS]}`,
                KeyConditionExpression: "#id = :id",
                ExpressionAttributeNames: { "#id": "id" },
                ExpressionAttributeValues: { ":id": { "S": props.id } }
            };
            // Query the table
            const data = await this.dynamoDbClient.query(queryParameters).promise();
            // Map and return the result
            let transactionList = this.mapTransactionResult(data.Items);
            let response = {
                transactionList: transactionList,
                count: data.Count || 0,
                lastEvaluatedKey: ((_a = data.LastEvaluatedKey) === null || _a === void 0 ? void 0 : _a.id.S) || ''
            };
            return new Promise(resolve => resolve(response));
        }
        catch (exception) {
            // exception: AWS.AWSError
            console.error(exception);
            throw exception;
        }
    }
    async updateCategory(transaction) {
        try {
            const updateItemParameters = {
                TableName: `${process.env[constants_1.constants.ENV_VAR_DYNAMODB_TABLE_TRANSACTIONS]}`,
                Key: {
                    "id": { "S": transaction.id }
                },
                UpdateExpression: "SET #category = :category",
                ExpressionAttributeNames: { "#category": "category" },
                ExpressionAttributeValues: { ":category": { "S": transaction.category } }
            };
            // Persist the item
            const data = await this.dynamoDbClient.updateItem(updateItemParameters).promise();
            // Map and return the result
            let categoryMappingPersisted = this.mapTransaction(data.Attributes);
            return new Promise(resolve => resolve(categoryMappingPersisted));
        }
        catch (exception) {
            // exception: AWS.AWSError
            console.error(exception);
            throw exception;
        }
    }
    mapTransactionResult(data) {
        let transactionList = [];
        if (data && data.length > 0) {
            for (let i = 0; i < data.length; i++) {
                transactionList.push(this.mapTransaction(data[i]));
            }
            // Sort the result by date
            transactionList.sort((a, b) => a.date - b.date);
        }
        return transactionList;
    }
    mapTransaction(item) {
        return {
            id: item === null || item === void 0 ? void 0 : item.id.S,
            value: Number.parseFloat((item === null || item === void 0 ? void 0 : item.value.N) || "-1"),
            type: item === null || item === void 0 ? void 0 : item.type.S,
            date: Date.parse((item === null || item === void 0 ? void 0 : item.date.S) || ""),
            description: item === null || item === void 0 ? void 0 : item.description.S,
            category: item === null || item === void 0 ? void 0 : item.category.S,
            reversed: item === null || item === void 0 ? void 0 : item.reversed.BOOL,
            smsId: item === null || item === void 0 ? void 0 : item.smsId.S
        };
    }
}
exports.TransactionRepository = TransactionRepository;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0cmFuc2FjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLHlDQUF5QztBQUN6QyxrREFBOEM7QUE0QjlDLE1BQWEscUJBQXFCO0lBSTlCO1FBQ0ksSUFBSSxDQUFDLGNBQWMsR0FBRyxhQUFhLENBQUMsb0JBQW9CLENBQUMscUJBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNuRixDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFnQjs7UUFDdkIsSUFBSTtZQUNBLHNEQUFzRDtZQUN0RCxNQUFNLGNBQWMsR0FBaUM7Z0JBQ2pELFNBQVMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQVMsQ0FBQyxtQ0FBbUMsQ0FBQyxFQUFFO2dCQUMxRSxLQUFLLEVBQUUsRUFBRTthQUNaLENBQUM7WUFFRiw4Q0FBOEM7WUFDOUMsSUFBSSxLQUFLLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUU7Z0JBQ2xDLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO2dCQUMxQixJQUFJLHlCQUF5QixHQUE2QyxFQUFFLENBQUM7Z0JBQzdFLElBQUksd0JBQXdCLEdBQTRDLEVBQUUsQ0FBQztnQkFHM0UsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFO29CQUNqQixnQkFBZ0IsR0FBRywwQkFBMEIsQ0FBQztvQkFDOUMsd0JBQXdCLENBQUMsWUFBWSxDQUFDLEdBQUcsTUFBTSxDQUFDO29CQUNoRCx5QkFBeUIsQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7aUJBQ3RFO2dCQUNELElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRTtvQkFDZixJQUFJLGdCQUFnQixJQUFJLEVBQUUsRUFBRTt3QkFDeEIsZ0JBQWdCLElBQUksT0FBTyxDQUFDO3FCQUMvQjtvQkFFRCxnQkFBZ0IsSUFBSSxzQkFBc0IsQ0FBQztvQkFDM0Msd0JBQXdCLENBQUMsVUFBVSxDQUFDLEdBQUcsTUFBTSxDQUFDO29CQUM5Qyx5QkFBeUIsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7aUJBQ2xFO2dCQUVELGNBQWMsQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztnQkFDbkQsY0FBYyxDQUFDLHdCQUF3QixHQUFHLHdCQUF3QixDQUFDO2dCQUNuRSxjQUFjLENBQUMseUJBQXlCLEdBQUcseUJBQXlCLENBQUM7Z0JBQ3JFLE9BQU8sY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDLHFCQUFxQjthQUNyRDtZQUVELGlCQUFpQjtZQUNqQixNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBRXRFLDRCQUE0QjtZQUM1QixJQUFJLGVBQWUsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzVELElBQUksUUFBUSxHQUF1QztnQkFDL0MsZUFBZSxFQUFFLGVBQWU7Z0JBQ2hDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUM7Z0JBQ3RCLGdCQUFnQixFQUFFLE9BQUEsSUFBSSxDQUFDLGdCQUFnQiwwQ0FBRSxFQUFFLENBQUMsQ0FBQyxLQUFJLEVBQUU7YUFDdEQsQ0FBQztZQUVGLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztTQUVwRDtRQUFDLE9BQU8sU0FBUyxFQUFFO1lBQ2hCLDBCQUEwQjtZQUMxQixPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7U0FDckQ7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFpQjs7UUFDekIsSUFBSTtZQUNBLE1BQU0sZUFBZSxHQUFrQztnQkFDbkQsU0FBUyxFQUFFLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBUyxDQUFDLG1DQUFtQyxDQUFDLEVBQUU7Z0JBQzFFLHNCQUFzQixFQUFFLFdBQVc7Z0JBQ25DLHdCQUF3QixFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRTtnQkFDekMseUJBQXlCLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFFO2FBQzFELENBQUM7WUFFRixrQkFBa0I7WUFDbEIsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUV4RSw0QkFBNEI7WUFDNUIsSUFBSSxlQUFlLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUM1RCxJQUFJLFFBQVEsR0FBc0M7Z0JBQzlDLGVBQWUsRUFBRSxlQUFlO2dCQUNoQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDO2dCQUN0QixnQkFBZ0IsRUFBRSxPQUFBLElBQUksQ0FBQyxnQkFBZ0IsMENBQUUsRUFBRSxDQUFDLENBQUMsS0FBSSxFQUFFO2FBQ3RELENBQUM7WUFFRixPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7U0FFcEQ7UUFBQyxPQUFPLFNBQVMsRUFBRTtZQUNoQiwwQkFBMEI7WUFDMUIsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN6QixNQUFNLFNBQVMsQ0FBQztTQUNuQjtJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsY0FBYyxDQUFDLFdBQXdCO1FBQ3pDLElBQUk7WUFFQSxNQUFNLG9CQUFvQixHQUF1QztnQkFDN0QsU0FBUyxFQUFFLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBUyxDQUFDLG1DQUFtQyxDQUFDLEVBQUU7Z0JBQzFFLEdBQUcsRUFBRTtvQkFDRCxJQUFJLEVBQUUsRUFBRSxHQUFHLEVBQUcsV0FBVyxDQUFDLEVBQUUsRUFBRTtpQkFDakM7Z0JBQ0QsZ0JBQWdCLEVBQUUsMkJBQTJCO2dCQUM3Qyx3QkFBd0IsRUFBRSxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUU7Z0JBQ3JELHlCQUF5QixFQUFFLEVBQUUsV0FBVyxFQUFFLEVBQUUsR0FBRyxFQUFFLFdBQVcsQ0FBQyxRQUFRLEVBQUUsRUFBRTthQUM1RSxDQUFDO1lBRUYsbUJBQW1CO1lBQ25CLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUVsRiw0QkFBNEI7WUFDNUIsSUFBSSx3QkFBd0IsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNwRSxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUMsQ0FBQztTQUVwRTtRQUFDLE9BQU8sU0FBUyxFQUFFO1lBQ2hCLDBCQUEwQjtZQUMxQixPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3pCLE1BQU0sU0FBUyxDQUFDO1NBQ25CO0lBQ0wsQ0FBQztJQUVPLG9CQUFvQixDQUFDLElBQTRCO1FBQ3JELElBQUksZUFBZSxHQUF1QixFQUFFLENBQUM7UUFFN0MsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDekIsS0FBSyxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQzlCLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3REO1lBRUQsMEJBQTBCO1lBQzFCLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFNLEVBQUUsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM3RDtRQUVELE9BQU8sZUFBZSxDQUFDO0lBQzNCLENBQUM7SUFFTyxjQUFjLENBQUMsSUFBZ0M7UUFDbkQsT0FBTztZQUNILEVBQUUsRUFBRSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsRUFBRSxDQUFDLENBQUM7WUFDZCxLQUFLLEVBQUUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFBLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxLQUFLLENBQUMsQ0FBQyxLQUFJLElBQUksQ0FBQztZQUMvQyxJQUFJLEVBQUUsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLElBQUksQ0FBQyxDQUFDO1lBQ2xCLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUEsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLElBQUksQ0FBQyxDQUFDLEtBQUksRUFBRSxDQUFDO1lBQ3BDLFdBQVcsRUFBRSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsV0FBVyxDQUFDLENBQUM7WUFDaEMsUUFBUSxFQUFFLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxRQUFRLENBQUMsQ0FBQztZQUMxQixRQUFRLEVBQUUsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLFFBQVEsQ0FBQyxJQUFJO1lBQzdCLEtBQUssRUFBRSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsS0FBSyxDQUFDLENBQUM7U0FDdkIsQ0FBQztJQUNOLENBQUM7Q0FFSjtBQW5KRCxzREFtSkM7QUFBQSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgQVdTIGZyb20gJ2F3cy1zZGsnO1xyXG5pbXBvcnQgKiBhcyBkeW5hbW9kYlV0aWxzIGZyb20gJy4vdXRpbHMnO1xyXG5pbXBvcnQgeyBjb25zdGFudHMgfSBmcm9tICcuLi91dGlscy9jb25zdGFudHMnXHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFRyYW5zYWN0aW9uIHtcclxuICAgIGlkPzogc3RyaW5nLFxyXG4gICAgdmFsdWU/OiBudW1iZXIsXHJcbiAgICB0eXBlPzogc3RyaW5nLFxyXG4gICAgZGF0ZT86IG51bWJlcixcclxuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nLFxyXG4gICAgY2F0ZWdvcnk/OiBzdHJpbmcsXHJcbiAgICByZXZlcnNlZD86IGJvb2xlYW4sXHJcbiAgICBzbXNJZD86IHN0cmluZ1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIExpc3RQcm9wcyB7XHJcbiAgICBzdGFydERhdGU/OiBzdHJpbmcsXHJcbiAgICBlbmREYXRlPzogc3RyaW5nXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlQcm9wcyB7XHJcbiAgICBpZDogc3RyaW5nXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgVHJhbnNhY3Rpb25SZXBvc2l0b3J5TGlzdFJlc3BvbnNlIHtcclxuICAgIHRyYW5zYWN0aW9uTGlzdDogQXJyYXk8VHJhbnNhY3Rpb24+LFxyXG4gICAgY291bnQ6IG51bWJlcixcclxuICAgIGxhc3RFdmFsdWF0ZWRLZXk6IHN0cmluZ1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgVHJhbnNhY3Rpb25SZXBvc2l0b3J5IHtcclxuXHJcbiAgICBwcml2YXRlIGR5bmFtb0RiQ2xpZW50OiBBV1MuRHluYW1vREI7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5keW5hbW9EYkNsaWVudCA9IGR5bmFtb2RiVXRpbHMuY3JlYXRlRHluYW1vRGJDbGllbnQoY29uc3RhbnRzLkFXU19SRUdJT04pO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGxpc3QocHJvcHM6IExpc3RQcm9wcyk6IFByb21pc2U8VHJhbnNhY3Rpb25SZXBvc2l0b3J5TGlzdFJlc3BvbnNlPiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgLy8gSWYgaXQgaXMgYSBzZWFyY2ggd2l0aG91dCBwYXJhbWV0ZXIgaXQgaXMgcGFnaW5hdGVzXHJcbiAgICAgICAgICAgIGNvbnN0IHNjYW5QYXJhbWV0ZXJzOiBBV1MuRHluYW1vREIuVHlwZXMuU2NhbklucHV0ID0ge1xyXG4gICAgICAgICAgICAgICAgVGFibGVOYW1lOiBgJHtwcm9jZXNzLmVudltjb25zdGFudHMuRU5WX1ZBUl9EWU5BTU9EQl9UQUJMRV9UUkFOU0FDVElPTlNdfWAsXHJcbiAgICAgICAgICAgICAgICBMaW1pdDogMTBcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgcXVlcnkgd2l0aCB0aGUgZmlsdGVyIHByb3BlcnRpZXNcclxuICAgICAgICAgICAgaWYgKHByb3BzLnN0YXJ0RGF0ZSB8fCBwcm9wcy5lbmREYXRlKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZmlsdGVyRXhwcmVzc2lvbiA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICBsZXQgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogQVdTLkR5bmFtb0RCLkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZU1hcCA9IHt9O1xyXG4gICAgICAgICAgICAgICAgbGV0IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogQVdTLkR5bmFtb0RCLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lTWFwID0ge307XHJcblxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBpZiAocHJvcHMuc3RhcnREYXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyRXhwcmVzc2lvbiA9IFwiI3N0YXJ0RGF0ZSA+PSA6c3RhcnREYXRlXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzW1wiI3N0YXJ0RGF0ZVwiXSA9IFwiZGF0ZVwiO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbXCI6c3RhcnREYXRlXCJdID0geyBcIlNcIjogcHJvcHMuc3RhcnREYXRlIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAocHJvcHMuZW5kRGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJFeHByZXNzaW9uICE9IFwiXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyRXhwcmVzc2lvbiArPSBcIiBhbmQgXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJFeHByZXNzaW9uICs9IFwiI2VuZERhdGUgPD0gOmVuZERhdGVcIjtcclxuICAgICAgICAgICAgICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbXCIjZW5kRGF0ZVwiXSA9IFwiZGF0ZVwiO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbXCI6ZW5kRGF0ZVwiXSA9IHsgXCJTXCI6IHByb3BzLmVuZERhdGUgfTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBzY2FuUGFyYW1ldGVycy5GaWx0ZXJFeHByZXNzaW9uID0gZmlsdGVyRXhwcmVzc2lvbjtcclxuICAgICAgICAgICAgICAgIHNjYW5QYXJhbWV0ZXJzLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyA9IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcztcclxuICAgICAgICAgICAgICAgIHNjYW5QYXJhbWV0ZXJzLkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPSBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzO1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHNjYW5QYXJhbWV0ZXJzLkxpbWl0OyAvLyBSZXR1cm4gZXZlcnl0aGluZyFcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gU2NhbiB0aGUgdGFibGVcclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuZHluYW1vRGJDbGllbnQuc2NhbihzY2FuUGFyYW1ldGVycykucHJvbWlzZSgpO1xyXG5cclxuICAgICAgICAgICAgLy8gTWFwIGFuZCByZXR1cm4gdGhlIHJlc3VsdFxyXG4gICAgICAgICAgICBsZXQgdHJhbnNhY3Rpb25MaXN0ID0gdGhpcy5tYXBUcmFuc2FjdGlvblJlc3VsdChkYXRhLkl0ZW1zKTtcclxuICAgICAgICAgICAgbGV0IHJlc3BvbnNlOiBUcmFuc2FjdGlvblJlcG9zaXRvcnlMaXN0UmVzcG9uc2UgID0ge1xyXG4gICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25MaXN0OiB0cmFuc2FjdGlvbkxpc3QsXHJcbiAgICAgICAgICAgICAgICBjb3VudDogZGF0YS5Db3VudCB8fCAwLFxyXG4gICAgICAgICAgICAgICAgbGFzdEV2YWx1YXRlZEtleTogZGF0YS5MYXN0RXZhbHVhdGVkS2V5Py5pZC5TIHx8ICcnXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiByZXNvbHZlKHJlc3BvbnNlKSk7XHJcblxyXG4gICAgICAgIH0gY2F0Y2ggKGV4Y2VwdGlvbikge1xyXG4gICAgICAgICAgICAvLyBleGNlcHRpb246IEFXUy5BV1NFcnJvclxyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVqZWN0cyA9PiByZWplY3RzKGV4Y2VwdGlvbikpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBxdWVyeShwcm9wczogUXVlcnlQcm9wcyk6IFByb21pc2U8VHJhbnNhY3Rpb25SZXBvc2l0b3J5TGlzdFJlc3BvbnNlPiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgcXVlcnlQYXJhbWV0ZXJzOiBBV1MuRHluYW1vREIuVHlwZXMuUXVlcnlJbnB1dCA9IHtcclxuICAgICAgICAgICAgICAgIFRhYmxlTmFtZTogYCR7cHJvY2Vzcy5lbnZbY29uc3RhbnRzLkVOVl9WQVJfRFlOQU1PREJfVEFCTEVfVFJBTlNBQ1RJT05TXX1gLFxyXG4gICAgICAgICAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogXCIjaWQgPSA6aWRcIixcclxuICAgICAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogeyBcIiNpZFwiOiBcImlkXCIgfSxcclxuICAgICAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHsgXCI6aWRcIjogeyBcIlNcIjogcHJvcHMuaWQgfSB9XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAvLyBRdWVyeSB0aGUgdGFibGVcclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuZHluYW1vRGJDbGllbnQucXVlcnkocXVlcnlQYXJhbWV0ZXJzKS5wcm9taXNlKCk7XHJcblxyXG4gICAgICAgICAgICAvLyBNYXAgYW5kIHJldHVybiB0aGUgcmVzdWx0XHJcbiAgICAgICAgICAgIGxldCB0cmFuc2FjdGlvbkxpc3QgPSB0aGlzLm1hcFRyYW5zYWN0aW9uUmVzdWx0KGRhdGEuSXRlbXMpO1xyXG4gICAgICAgICAgICBsZXQgcmVzcG9uc2U6IFRyYW5zYWN0aW9uUmVwb3NpdG9yeUxpc3RSZXNwb25zZSA9IHtcclxuICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uTGlzdDogdHJhbnNhY3Rpb25MaXN0LFxyXG4gICAgICAgICAgICAgICAgY291bnQ6IGRhdGEuQ291bnQgfHwgMCxcclxuICAgICAgICAgICAgICAgIGxhc3RFdmFsdWF0ZWRLZXk6IGRhdGEuTGFzdEV2YWx1YXRlZEtleT8uaWQuUyB8fCAnJ1xyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gcmVzb2x2ZShyZXNwb25zZSkpO1xyXG5cclxuICAgICAgICB9IGNhdGNoIChleGNlcHRpb24pIHtcclxuICAgICAgICAgICAgLy8gZXhjZXB0aW9uOiBBV1MuQVdTRXJyb3JcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihleGNlcHRpb24pO1xyXG4gICAgICAgICAgICB0aHJvdyBleGNlcHRpb247XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHVwZGF0ZUNhdGVnb3J5KHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbik6IFByb21pc2U8VHJhbnNhY3Rpb24+IHtcclxuICAgICAgICB0cnkge1xyXG5cclxuICAgICAgICAgICAgY29uc3QgdXBkYXRlSXRlbVBhcmFtZXRlcnM6IEFXUy5EeW5hbW9EQi5UeXBlcy5VcGRhdGVJdGVtSW5wdXQgPSB7XHJcbiAgICAgICAgICAgICAgICBUYWJsZU5hbWU6IGAke3Byb2Nlc3MuZW52W2NvbnN0YW50cy5FTlZfVkFSX0RZTkFNT0RCX1RBQkxFX1RSQU5TQUNUSU9OU119YCxcclxuICAgICAgICAgICAgICAgIEtleToge1xyXG4gICAgICAgICAgICAgICAgICAgIFwiaWRcIjogeyBcIlNcIiA6IHRyYW5zYWN0aW9uLmlkIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBVcGRhdGVFeHByZXNzaW9uOiBcIlNFVCAjY2F0ZWdvcnkgPSA6Y2F0ZWdvcnlcIixcclxuICAgICAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogeyBcIiNjYXRlZ29yeVwiOiBcImNhdGVnb3J5XCIgfSxcclxuICAgICAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHsgXCI6Y2F0ZWdvcnlcIjogeyBcIlNcIjogdHJhbnNhY3Rpb24uY2F0ZWdvcnkgfSB9XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAvLyBQZXJzaXN0IHRoZSBpdGVtXHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLmR5bmFtb0RiQ2xpZW50LnVwZGF0ZUl0ZW0odXBkYXRlSXRlbVBhcmFtZXRlcnMpLnByb21pc2UoKTtcclxuXHJcbiAgICAgICAgICAgIC8vIE1hcCBhbmQgcmV0dXJuIHRoZSByZXN1bHRcclxuICAgICAgICAgICAgbGV0IGNhdGVnb3J5TWFwcGluZ1BlcnNpc3RlZCA9IHRoaXMubWFwVHJhbnNhY3Rpb24oZGF0YS5BdHRyaWJ1dGVzKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gcmVzb2x2ZShjYXRlZ29yeU1hcHBpbmdQZXJzaXN0ZWQpKTtcclxuXHJcbiAgICAgICAgfSBjYXRjaCAoZXhjZXB0aW9uKSB7XHJcbiAgICAgICAgICAgIC8vIGV4Y2VwdGlvbjogQVdTLkFXU0Vycm9yXHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXhjZXB0aW9uKTtcclxuICAgICAgICAgICAgdGhyb3cgZXhjZXB0aW9uO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG1hcFRyYW5zYWN0aW9uUmVzdWx0KGRhdGE/OiBBV1MuRHluYW1vREIuSXRlbUxpc3QpOiBBcnJheTxUcmFuc2FjdGlvbj4ge1xyXG4gICAgICAgIGxldCB0cmFuc2FjdGlvbkxpc3Q6IEFycmF5PFRyYW5zYWN0aW9uPiA9IFtdO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmIChkYXRhICYmIGRhdGEubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpPTA7IGk8ZGF0YS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25MaXN0LnB1c2godGhpcy5tYXBUcmFuc2FjdGlvbihkYXRhW2ldKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIFNvcnQgdGhlIHJlc3VsdCBieSBkYXRlXHJcbiAgICAgICAgICAgIHRyYW5zYWN0aW9uTGlzdC5zb3J0KChhOiBhbnksIGI6IGFueSkgPT4gYS5kYXRlIC0gYi5kYXRlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0cmFuc2FjdGlvbkxpc3Q7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBtYXBUcmFuc2FjdGlvbihpdGVtPzogQVdTLkR5bmFtb0RCLkF0dHJpYnV0ZU1hcCk6IFRyYW5zYWN0aW9uIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBpZDogaXRlbT8uaWQuUyxcclxuICAgICAgICAgICAgdmFsdWU6IE51bWJlci5wYXJzZUZsb2F0KGl0ZW0/LnZhbHVlLk4gfHwgXCItMVwiKSxcclxuICAgICAgICAgICAgdHlwZTogaXRlbT8udHlwZS5TLFxyXG4gICAgICAgICAgICBkYXRlOiBEYXRlLnBhcnNlKGl0ZW0/LmRhdGUuUyB8fCBcIlwiKSxcclxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGl0ZW0/LmRlc2NyaXB0aW9uLlMsXHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiBpdGVtPy5jYXRlZ29yeS5TLFxyXG4gICAgICAgICAgICByZXZlcnNlZDogaXRlbT8ucmV2ZXJzZWQuQk9PTCxcclxuICAgICAgICAgICAgc21zSWQ6IGl0ZW0/LnNtc0lkLlNcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxufTsiXX0=